import type { NextPage } from 'next';
import Head from 'next/head';
import { useRouter } from 'next/router';
import { useEffect, useState } from 'react';
import Wrapper from '../src/components/ui/Wrapper/wrapper';
import { useAuth } from '../src/hooks/useAuth';
import MapBoxContainer from '../src/components/containers/Map/mapBox.container';
import useUsersMarkers from '../src/hooks/useUsersMarkers';
import Banner from '../src/components/ui/Banner/banner';
import { useTranslation } from 'react-i18next';
import useUsersGeolocation from '../src/hooks/useUsersGeolocation';
import { UserGeolocation } from '../src/models/usersGeolocation';
import { useGeolocationProvider } from '../src/hooks/useGeolocationProvider';
import UsersListGroup from '../src/components/containers/UsersList/usersListGroup';
import PageTitle from '../src/components/ui/PageTitle/PageTitle';
import {
  MapHolder,
  MapHolderFooter,
} from '../src/components/containers/Map/mapBox.styled';
import Widget from '../src/components/ui/Widget/widget';
import useChartData from '../src/hooks/useChartData';
import { Grid } from '@mui/material';
import Loader from '../src/components/ui/Loader/loader';
import { getSplashScreen } from '../src/components/ui/SplashScreen/SplashScreen.model';
import { SplashScreen } from '../src/components/ui/SplashScreen/SplashScreen';

const Home: NextPage = () => {
  const [selectedUser, setSelectedUser] = useState<UserGeolocation | null>(
    null
  );

  const router = useRouter();
  const { t } = useTranslation();
  const { user, loading } = useAuth();
  const { isLocationAllowed } = useGeolocationProvider();
  const usersGeolocation = useUsersGeolocation();
  const { statusesData, citiesData } = useChartData(usersGeolocation);
  const markers = useUsersMarkers(usersGeolocation);

  useEffect(() => {
    if (!loading && !user) {
      router.push('/login');
    }
  }, [user, loading, router]);

  if (!getSplashScreen()) {
    return <SplashScreen />;
  }

  if (!usersGeolocation) {
    return <Loader />;
  }

  const handleUserClick = (user: UserGeolocation) => setSelectedUser(user);

  return (
    <Wrapper>
      <Head>
        <title>whereiam</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main>
        {!isLocationAllowed ? (
          <Banner
            title={t('dashboard.bannerTitle')}
            buttonText={t('dashboard.bannerButtonText')}
            buttonHref="/user/profile"
          />
        ) : (
          <>
            <PageTitle title={t('dashboard.users')} />
            <MapHolder>
              <MapBoxContainer markers={markers} selectedUser={selectedUser} />
              <MapHolderFooter>
                <UsersListGroup
                  users={usersGeolocation}
                  onUserClick={handleUserClick}
                />
              </MapHolderFooter>
            </MapHolder>
            <Grid container spacing={2} sx={{ pt: 2 }}>
              <Grid item lg={6} md={6} sm={12} xs={12}>
                <Widget data={statusesData} title="Statuses" />
              </Grid>
              <Grid item lg={6} md={6} sm={12} xs={12}>
                <Widget data={citiesData} title="Cities" />
              </Grid>
            </Grid>
          </>
        )}
      </main>
    </Wrapper>
  );
};

export default Home;
